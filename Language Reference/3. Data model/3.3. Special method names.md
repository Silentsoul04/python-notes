## 3.3. Special method names

### [3.3.6. Emulating callable objects](https://docs.python.org/3.7/reference/datamodel.html#emulating-callable-objects)

模拟可调用对象[版本：3.7]

- object.\_\_call\_\_(*self*[, *args*...])

  当我们像调用函数一样调用类实例时，便会调用该方法。如果类中定义了该方法，那么在调用类实例 x 时：`x(arg1,arg2, ...)` 与  `x.__call__(arg1, arg2, ...)` 等效果。

### [3.3.7. Emulating container types](https://docs.python.org/3.7/reference/datamodel.html#emulating-container-types)

版本：3.7

通过定义本节中讲述的方法，便可实现容器(container)对象。
容器通常是指序列(如，列表或元组)或映射(如，字典)，但也可以表示其它容器类型。
第一组方法用于模拟序列或映射；对于序列来说，方法签名中参数 key 的范围是 `0 <= key < N` (N 表示序列的长度)，key 还可以是切片对象。

建议在映射中提供如下方法，并让其行为类似于"标准字典对象"中的同名方法：`keys()`, `values()`, `items()`, `get()`, `clear()`, `setdefault()`, `pop()`, `popitem()`, `copy()`, 和 `update()` 。 [`collections.abc`](https://docs.python.org/3.7/library/collections.abc.html#module-collections.abc) 模块提供了  [`MutableMapping`](https://docs.python.org/3.7/library/collections.abc.html#collections.abc.MutableMapping) 抽象基类，以便在创建新类时可从基类继承如下方法： [`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__), [`__setitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__setitem__), [`__delitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__delitem__), and `keys()`。

可变序列应提供如下方法，并让其行为类似于"标准列表对象"中的同名方法：`append()`, `count()`, `index()`, `extend()`, `insert()`, `pop()`, `remove()`,`reverse()` 和 `sort()`。
序列类型可通过定义如下方法，来实现加法(用于连接两个序列)和乘法(将序列本身进行重复)： [`__add__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__add__), [`__radd__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__radd__), [`__iadd__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iadd__), [`__mul__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__mul__), [`__rmul__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__rmul__) and[`__imul__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__imul__) —— 除此之外不要定义其它数值运算符。

建议映射和序列都实现 [`__contains__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__contains__) 方法，以便使用 `in` 进行成员测试；对于映射，`in` 将 key 作为测试对象；对于序列，`in` 将值作为测试对象。还建议在映射和序列中均实现 [`__iter__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iter__) 方法，以便对容器进行迭代；对于映射， [`__iter__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iter__) 应类似于 `keys()`；对于序列，迭代操作的对象是值。

#### \_\_len\_\_

`object.__len__(self)`

该函数应返回对象的长度(长度值是 `>=0` 的整数)，内置函数 [`len()`](https://docs.python.org/3.7/library/functions.html#len) 会调用此函数来获取长度值。另外，对于未定义 [`__bool__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__bool__) 方法的对象，在 Boolean 上下文中会将 [`__len__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__len__) 返回 0 的情形视为 `False`。

```python
class Cls(object):
    def __init__(self, lst):
        self._lst = lst

    def __len__(self):
        return len(self._lst)
```

**CPython 实现细节：**在 CPython 中，长度(length)的最大值不能超过 [`sys.maxsize`](https://docs.python.org/3.7/library/sys.html#sys.maxsize)。如果长度大于 `sys.maxsize`，某些功能(如 `len()`)便可能会引发 [`OverflowError`](https://docs.python.org/3.7/library/exceptions.html#OverflowError)。为了避免进行真值测试时抛出 `OverflowError`，对象必须定义 [`__bool__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__bool__) 方法。

#### \_\_iter\_\_

`object.__iter__(self)`

当需要容器提供迭代器(iterator)时，便会调用此方法。该方法会返回一个新的迭代器对象，通过该迭代器对象可遍历容器中的所有对象。如果容器本身就是迭代器，在调用该方法后，便会返回容器自身。对于映射对象，应使用键进行迭代。

迭代器对象同样需要实现该方法，并通过该方法返回其自身。有关迭代器的更多信息，请看 [Iterator Types](https://docs.python.org/3.7/library/stdtypes.html#typeiter) 。

```python
class Fib(object):
    def __reset(self):
        self.a = 1
        self.b = 1

    def __init__(self):
        self.__reset()


    def __iter__(self):
        """测试该方法前，请删除__contains__"""
        print("调用 __iter__()")
        self.__reset()
        return self

    def __next__(self):
        self.a, self.b = self.b, self.a + self.b  # 计算下一个值
        if self.a > 100000:  # 退出循环的条件
            print("停止迭代")
            raise StopIteration()
        return self.a  # 返回下一个值
```



#### \_\_contains\_\_

成员测试操作符 ([`in`](https://docs.python.org/3.7/reference/expressions.html#in) 和 [`not in`](https://docs.python.org/3.7/reference/expressions.html#not-in)) 常见的实现方式是：通过对序列进行迭代，以确定是否存在指定项。但是，容器对象可以使用下面这个方法来提供更高效的实现，该方法也可用于非序列对象。

`object.__contains__(self, item)`

该方法用于实现成员测试。如果 self 中包含 item，便会返回 `True` ；否则返回 `False`。对于映射对象，应将键作为测试对象，而非值或键值对。如果对象中未定义 `__contains__`，成员测试便会尝试通过 [`__iter__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iter__) 来迭代对象，以确定目标值是否存在。如果这两个方法都未定义，则会通过旧式序列迭代协议 [`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__), 来确定目标是否存在，[详见此处](https://docs.python.org/3.7/reference/expressions.html#membership-test-details)。





