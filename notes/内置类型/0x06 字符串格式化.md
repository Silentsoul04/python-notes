# 字符串格式化

[TOC]

[PEP 3101 -- Advanced String Formatting](https://www.python.org/dev/peps/pep-3101/)

[PEP 292 -- Simpler String Substitutions](https://www.python.org/dev/peps/pep-0292/)

## printf-style

> 本节涵盖了 [printf-style String Formatting](https://docs.python.org/3/library/stdtypes.html#old-string-formatting) 中的内容，并进行了扩展

**Note:** printf-style 的格式化操作存在一些缺陷，会导致许多常见的错误（例如无法正确显示元组和字典）。使用以下三种的字符串格式化方式，可避免这些错误。

-  [formatted string literal](https://docs.python.org/3/reference/lexical_analysis.html#f-strings)，也称*f-string*
- [`str.format()`](https://docs.python.org/3/library/stdtypes.html#str.format) 接口
- [template strings](https://docs.python.org/3/library/string.html#template-strings)  

字符串对象拥有一个独特的内置运算符：`%`  (modulo) ，也称格式化(*formatting*)运算符或插值(*interpolation*)运算符。该运算符的使用效果类似于 C 语言中 `sprintf()` 函数。

printf-style 有如下两种形式：

- `<format string> % <datum>` - `<format string>` 中只包含一个格式化序列(*format sequence*)，`<datum>` 必须是单个对象，且该对象不可以是多元素元组。

    ```python
    >>> "%s" % [1, 2, 3] # %s是一个格式化序列
    '[1, 2, 3]'
    >>> "%s" % dict(a=1, b=2, c=3)
    "{'a': 1, 'b': 2, 'c': 3}"
    >>> "%s" % (1,) # 可以是单元素的元组
    '1'
    >>> "%s" % (1, 2, 3) # 不可以是多元素元组
    TypeError: not all arguments converted during string formatting
    ```
    如果需要格式化输出的对象是一个多元素元组，则需要将该元组嵌套在一个单元素元组中：

    ```python
    >>> "%s" % ((1,2,3),)
    '(1, 2, 3)'
    ```

- `<format string> % <datums>` - `<format string>` 中包含 n 个格式化序列， `<datums>` 必须是包含 n 个基准值(*datum*)的元组，或有 n 个键值对的映射对象(如字典)。

    ```python
    >>> "%s %s %s" % ("a", "b", "c")
    'a b c'
    >>> "%(a)s %(b)s %(c)s" % dict(a=1, b=2, c=3)
    '1 2 3'
    >>> '%(language)s has %(number)03d quote types.'%{'language': "Python", "number": 2}
    'Python has 002 quote types.'
    
    >>># 不能直接给出参数，必须打包到数组中
    >>> "%s %s %s" % "a", "b", "c"
    TypeError: not enough arguments for format string
    ```


### 转换说明符

`<format string> ` 中的**格式化序列**也被称为**转换说明符**(*conversion specifier*)。
转换说明符至少需要包含两个字符( 如,  `%s` )。
转换说明符中各个组件(*components*)的顺序如下：

```
%[Mapping_key][Conversion_flags][Minimum_field_width][.Precision][Length_modifier][Conversion_type]
```

转换说明符中相关组件的描述如下：

1. `%` 标识转换说明符的起点

2. `mapping_key` (可选)，由带括号的字符序列组成，如  `(somename)` 。当 `<datums>` 是字典(或其它映射类型)时，则必须使用 `mapping_key` ，并用 `mapping_key` 表示字典中相应的 `key` (这种情况下，转换说明符中不会出现 `*` 星号，因为只有 `<datums>` 是序列类型时才能使用 `*` )。

   ```Python
   >>> aDict = dict(a=1, b=2, c=3)
   >>> "%(b)s %(a)s " % aDict # 不必使用所有key，顺序也可以变化
   '2 1 '
   >>> '%(language)s has %(number)03d quote types.'%{'language': "Python", "number": 2}
   'Python has 002 quote types.'
   ```

3. `Conversion_flags` (可选)，会影响某些装换类型(*conversion types*)的结果。

4. `Minimum_field_width` (可选)。如果将 `Minimum_field_width` 设置为 `'*'` 星号(*asterisk*)，那么需要将实际的`width`值放置在相应的基准值之前。如果 `.Precision` 也使用了 `*` ，那么基准值应位于 `width` 值和  `.precision` 值之后。

   ```Python
   >>> "%*s,%*s,%s" % (4, "a", 4, "b", "c") # 4是width，'a'是基准值
   '   a,   b,c'
   ```

5. `.Precision`  (可选)，精度值跟在 `.`(*dot*) 之后。如果将`.Precision`  设置为 `'*'` 星号，那么需要将实际的精度值放置在相应的基准值之前。

   ```python
   >>> import math
   >>> "%.*f" % (2, math.pi) # 2是精度，'a'是基准值
   '3.14'
   ```

6. `Length_modifier` (可选)，虽然可以添加 length 修饰符 (`h`, `l`, 或 `L`) ，但该修饰符会被 Python 忽略。原因是 Python 并不需要该修饰符，所以在 Python 中 `%ld` 与 `%d` 完全等价。

7. `Conversion_type` 

### Conversion_flags

```
%[Mapping_key][Conversion_flags][Minimum_field_width][.Precision][Length_modifier][Conversion_type]
```

`Conversion_flags` 字符含义如下：

| Flag  | Meaning                                                      |
| ----- | ------------------------------------------------------------ |
| `'#'` | 使用"替代形式(*alternate form*) "表示转换后的内容，在**Notes**小节中会详细阐述 |
| `'0'` | 在数值左侧使用 0 进行填充，而不是默认的空格。                |
| `'-'` | 将转换后的内容在给定的字段宽度内左对齐，默认是右对齐(如果 `'-'` 和 `'0'` 同时存在，`'-'` 会覆盖 `'0'` )。如果转换后的内容大于给定的字段宽度，则不进行对齐。 |
| `' '` | 在正数前插入一个空格                                         |
| `'+'` | 在正数前插入  `'+'`  (会覆盖 `' '` 标记)，负数会默认显示负号 |

```python
>>> import math
# '0' 演示
>>> "%06.2f" % math.pi
'003.14'
# ‘-’ 演示
>>> "%-6s" % "Hi!"
'Hi!   '
>>> "%-06.2f" % math.pi
'3.14  '
```

### Conversion_type

```
%[Mapping_key][Conversion_flags][Minimum_field_width][.Precision][Length_modifier][Conversion_type]
```

`Conversion_type` 字符含义如下

| Conversion | Meaning                                                      | Notes |
| ---------- | ------------------------------------------------------------ | ----- |
| `'d'`      | 有符号十进制整数                                             |       |
| `'i'`      | 有符号十进制整数                                             |       |
| `'o'`      | 有符号八进制整数                                             | (1)   |
| `'u'`      | 废弃的类型，含义与 `'d'` 相同                                | (6)   |
| `'x'`      | 有符号十六进制数(小写)                                       | (2)   |
| `'X'`      | 有符号十六进制数(大写)                                       | (2)   |
| `'e'`      | 指数格式的浮点数(小写)                                       | (3)   |
| `'E'`      | 指数格式的浮点数(大写)                                       | (3)   |
| `'f'`      | 小数格式的浮点数                                             | (3)   |
| `'F'`      | 小数格式的浮点数                                             | (3)   |
| `'g'`      | 浮点格式。如果指数小于 -4 或大于等于精度时，会采用 `'e'` 格式；否则采用小数格式的浮点数。 | (4)   |
| `'G'`      | 浮点格式。如果指数小于 -4 或大于等于精度时，会采用 `'E'` 格式；否则采用小数格式的浮点数。 | (4)   |
| `'c'`      | 单个字符(接受整数，或仅包含单个字符的字符串)                 |       |
| `'r'`      | String (使用 [`repr()`](https://docs.python.org/3/library/functions.html#repr) 函数转换相应的 Python 对象). | (5)   |
| `'s'`      | String (使用 [`str()`](https://docs.python.org/3/library/stdtypes.html#str) 函数转换相应的Python 对象). | (5)   |
| `'a'`      | String (使用 [`ascii()`](https://docs.python.org/3/library/functions.html#ascii)函数转换相应的Python 对象). | (5)   |
| `'%'`      | 不进行转换，会直接得到 `'%'` 。                              |       |

关于 `'g'` 的示例：

```python
# 格式化的默认精度是6位小数，所以当整数部分的长度大于等于7时，
# 便会采用指数形式
>>> "%g" % 1234567
'1.23457e+06'
>>> "%.2g" % 1234
'1.2e+03'
# 指数小于-4，也会采用指数形式
>>> "%g" % 0.000023456789
'2.34568e-05'
```

关于 `'%'` 标记， 如果在字符串中需要用到一个普通的 `%` ，便可在`<format string> ` 中使用 `'%%'` 得到一个 `'%'` 。

```
>>> 'growth rate: %d %%' % 7
'growth rate: 7 %'
```

#### Notes

1. 如果使用转换标识符 `#`，则会在第一个数字前插入八进制标识符 (`'0o'`)  

   ```python
   >>> '%#o' % 10
   '0o12'
   ```

2. 如果使用转换标识符 `#`，则会在第一个数字前插入十六进制标识符 ( `'0x'` or `'0X'` ) 

   ```python
   >>> '%#x' % 10
   '0xa'
   ```

3. 如果使用转换标识符 `#`，则会导致结果始终包含小数点，即使小数点后没有数字。
   精度(*precision*)用于确定小数点后的有效位数，默认是 6 位小数。

   ```python
   >>> "%#.0f" % 2
   '2.'
   >>> "%.0f" % 2
   '2'
   >>> "%#f" % 2
   '2.000000'
   >>> "%f" % 2
   '2.000000'
   ```

4. 如果使用转换标识符 `#`，则会导致结果始终包含小数点，即使小数点后没有数字。
   精度用于确定小数点后的有效位数，默认是 6 位小数。

   ```python
   >>> "%#.0g" % 0.00002
   '2.e-05'
   >>> "%.0g" % 0.00002
   '2e-05'
   >>> "%#g" % 0.00002
   '2.00000e-05'
   ```

5. 如果精度值为 `N` ，则会截取结果的前 `N` 个字符。

   ```python
   >>> "%.4s" % '1234567'
   '1234'
   >>> "%.4r" % '1234567'
   "'123"
   >>> "%.4a" % '1234567'
   "'123"
   ```

6. 参考 [**PEP 237**](https://www.python.org/dev/peps/pep-0237).

因为 Python 的字符串有明确的长度，因此 `%s` 转换不会假定字符串以 `\0` 结尾。

**Changed in version 3.1**：对绝对值超过 1e50 的值进行 `%f` 转换时，不会再将 `%f` 替换为 `%g` 。

## f-string

> 有关 *f-string* 的详细信息，请阅读 [2.4.3. Formatted string literals](https://docs.python.org/3.7/reference/lexical_analysis.html#formatted-string-literals)，这里仅提供简要概述。
> *f-string* 和 `string .format()` 使用相同的格式化说明符——[format specifier mini-language](https://docs.python.org/3.7/library/string.html#formatspec) 

前缀中包含  `f` 或 `F`  的字符串字面值属于 *formatted string literal* (或称 *f-string* ) 。这些字符串可能会包含替换字段(*replacement_field*)，替换字段是指被置于花括号 `{}` 中的表达式。虽然其它字符串字面值总会拥有一个常量值，但格式化字符串却会在运行时对**表达式求值**。*f-string* 的语法如下：

```python
f_string          ::=  (literal_char | "{{" | "}}" | replacement_field)*
replacement_field ::=  "{" f_expression ["!" conversion] [":" format_spec] "}"
f_expression      ::=  (conditional_expression | "*" or_expr)
                         ("," conditional_expression | "," "*" or_expr)* [","]
                       | yield_expression
conversion        ::=  "s" | "r" | "a"
format_spec       ::=  (literal_char | NULL | replacement_field)*
literal_char      ::=  <any code point except "{", "}" or NULL>
```

*f-string* 中的表达式 `f_expression` 应被视作位于括号中的常规 Python 表达式。

Python 会使用 [`format()`](https://docs.python.org/3.6/library/functions.html#format) 协议对表达式的结果 (或是经转换后的结果) 进行格式化。格式化说明符 (*format specifier*) 会被传递到表达式的结果的  [`__format__()`](https://docs.python.org/3.6/reference/datamodel.html#object.__format__) 方法中，或是被传递到经转换后的结果的 [`__format__()`](https://docs.python.org/3.6/reference/datamodel.html#object.__format__) 方法中。当格式说明符被省略时，会传递一个空字符串。然后将格式化之后的最终结果插入到整个字符串的最终值中。

顶层 `replacement_field` 中可能会包含嵌套的替换字段。这些嵌套的字段可能会包含它们自己的转换字段和格式化序列，但是不能包含更深层次的嵌套字段。

一些简单示例：

```python
>>> name = "Fred"
>>> f"He said his name is {name!r}."
"He said his name is 'Fred'."
>>> f"He said his name is {repr(name)}."  # repr() is equivalent to !r
"He said his name is 'Fred'."
>>> width = 10
>>> precision = 4
>>> value = decimal.Decimal("12.34567")
>>> f"result: {value:{width}.{precision}}"  # nested fields 嵌套字段
'result:      12.35'
>>> today = datetime(year=2017, month=1, day=27)
>>> f"{today:%B %d, %Y}"  # using date format specifier
'January 27, 2017'
>>> number = 1024
>>> f"{number:#0x}"  # using integer format specifier
'0x400'
```

### vs. str.format

*f-string* 和 `string .format()` 使用相同的格式化说明符——[format specifier mini-language](https://docs.python.org/3.7/library/string.html#formatspec) ，它们的区别在于：

- *f-string* 的 `replacement_field` 可接受任意表达式

  ```
  replacement_field ::=  "{" f_expression ["!" conversion] [":" format_spec] "}"
  ```

- `string.fomat()` 只能接受字段名

  ```
  replacement_field ::=  "{" [field_name] ["!" conversion] [":" format_spec] "}"
  ```

## str.format

> 本节涵盖了 [str.format(*args, **kwargs)](https://docs.python.org/3.7/library/stdtypes.html#str.format) 中的内容

该方法用于执行字符串格式化操作，字符串对象中需包含：文本字面值和替换字段。替换字段是指被置于花括弧(*curly braces*) `{}` 中的表达式，其中可包含位置实参的数值索引，或包含关键字实参的名称。`str.format` 方法会基于当前字符串创建一个新副本，并用实参替换掉副本中对应的字段。

```python
>>> "The sum of 1 + 2 is {0}".format(1+2)
'The sum of 1 + 2 is 3'
```

有关格式化字符串的详细语法，请阅读  [Format String Syntax](https://docs.python.org/3/library/string.html#formatstrings)

> Note - When formatting a number ([`int`](https://docs.python.org/3.7/library/functions.html#int), [`float`](https://docs.python.org/3.7/library/functions.html#float), [`complex`](https://docs.python.org/3.7/library/functions.html#complex), [`decimal.Decimal`](https://docs.python.org/3.7/library/decimal.html#decimal.Decimal) and subclasses) with the `n` type (ex: `'{:n}'.format(1234)`), the function temporarily sets the `LC_CTYPE` locale to the `LC_NUMERIC` locale to decode `decimal_point` and`thousands_sep` fields of `localeconv()` if they are non-ASCII or longer than 1 byte, and the `LC_NUMERIC` locale is different than the `LC_CTYPE` locale. This temporary change affects other threads.

Changed in version 3.7: When formatting a number with the `n` type, the function sets temporarily the `LC_CTYPE` locale to the `LC_NUMERIC` locale in some cases.

## format()

https://docs.python.org/3.6/reference/datamodel.html#object.__format__

## Template strings

> 更多细节请阅读笔记：『string — Common string operations.md』

模板字符串只能执行简单的替换操作，不支持格式化语法(例如，无法控制浮点数的精度)。

Template strings support `$`-based substitutions, using the following rules:

- `$$` is an escape; it is replaced with a single `$`.
- `$identifier` names a substitution placeholder matching a mapping key of`"identifier"`. By default, `"identifier"` is restricted to any case-insensitive ASCII alphanumeric string (including underscores) that starts with an underscore or ASCII letter. The first non-identifier character after the `$` character terminates this placeholder specification.
- `${identifier}` is equivalent to `$identifier`. It is required when valid identifier characters follow the placeholder but are not part of the placeholder, such as `"${noun}ification"`.

```python
>>> values = {'var': 'foo'}
>>> t=Template("""\
Escape          : $$
Variable        : $var
Variable in text: ${var}iable""")
>>> print(t.substitute(values))
Escape          : $
Variable        : foo
Variable in text: fooiable
>>> print(t.safe_substitute()) # 可避免KeyError
Escape          : $
Variable        : $var
Variable in text: ${var}iable
```







通过例子来对比下：

- 模板插入
- 使用 `%` 操作符的格式化语法
- 使用 `str.format()` 的字符串语法

```py
# string_template.py
import string

values = {'var': 'foo'}

t = string.Template("""
Variable        : $var
Escape          : $$
Variable in text: ${var}iable
""")

print('TEMPLATE:', t.substitute(values))

s = """
Variable        : %(var)s
Escape          : %%
Variable in text: %(var)siable
"""

print('INTERPOLATION:', s % values)

s = """
Variable        : {var}
Escape          : {{}}
Variable in text: {var}iable
"""

print('FORMAT:', s.format(**values))
```

前两种情况，触发字符（`$` 和 `%`）需要重复两次来转义。对于第三种格式化语法，`{` 和 `}` 都需要重复才能转义。

```python
$ python3 string_template.py

TEMPLATE:
Variable        : foo
Escape          : $
Variable in text: fooiable

INTERPOLATION:
Variable        : foo
Escape          : %
Variable in text: fooiable

FORMAT:
Variable        : foo
Escape          : {}
Variable in text: fooiable
```

上面三种方法的一个关键不同点是：没有考虑参数的类型。这些值被转换成字符串，然后插入到结果当中，没有可用的格式化选项。例如，无法控制用来表示浮点数的数字的个数。